name: Generate Audio Only

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  generate-audio:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: 🛠 Set up Python environment
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m venv .venv

      - name: 📦 Install Python dependencies
        run: |
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install --no-cache-dir google-cloud-texttospeech

      - name: 🔐 Write Google credentials to file
        run: echo "$GOOGLE_CREDENTIALS_JSON" > google-credentials.json
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}

      - name: 🎤 Generate blog voiceover (split & merge)
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/google-credentials.json"
          .venv/bin/python generate_audio_from_blog.py

      - name: 🚀 Commit and push blog_voiceover.mp3
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add blog_voiceover.mp3
          git commit -m "Generated blog voiceover [manual run] [skip ci]" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push
